#!/bin/bash

_copy(){	#Начало функции
	#Сохраняем начальную директорию, чтоб вернуться позже
	local begdir=$(pwd)
	local i="NULL"
	#Считываем названия файлов в массивы:
	cd "./$1"
	local fs1=(*)	#работает только в bash, при переходе в sh надо поменять!
	cd $begdir
	cd "./$2"
	local fs2=(*)
	
	echo "Первая директория:"
	for i in ${fs1[@]}
	do
		echo " $i"
	done
	
	echo "Вторая директория:"
	for i in ${fs2[@]}
	do
		echo " $i"
	done
	cd $begdir
	
	#Ищем различия между двумя массивами:
	#Копируем все файлы из второй директории, которых нет в первой (или у которых позже дата изменения) в первую
	local flag=false
	local j=0

	if [[ ${fs2[@]} == "*" ]]
	then
		echo "Вторая директория является пустой."
	else
		for i in ${fs1[@]}	#i - файл первой директории, j - номер файла второй директории
		do 
			while true
			do
		    #Проверяем, не вышли ли мы за пределы второй папки
		    if (("$j">="${#fs2[@]}"))
		    then
		      #Заканчиваем
		      flag="true"
		      break
		    fi
		    
		    echo "$i" == "${fs2[$j]}"
		    
		    #Сверяем названия файлов
		    if [ "$i" == "${fs2[$j]}" ] 
		    then 
		    	#Проверяем, являются ли копируемые элементы папками или файлами?
		    	if [[ -d "$begdir/$1/$i" ]] && [[ -d "$begdir/$2/$i" ]]	#Оба файла - папки
		    	then
		    		echo "  Выполняем скрипт для вложенных папок: $begdir/$1/$i и $begdir/$2/$i "
		    		echo " i=$i, j=$j - до рекурсии"
		    		_copy "$1/$i" "$2/$i" #Р Е К У Р С И Я
		    		echo "  !!! Конец рекурсии"
		    		echo " i=$i, j=$j - после рекурсии"
		    		echo "   Продолжаем работу с $1 и $2"
		    		echo "    ${fs1[@]}  || ${fs2[@]}" 
		      elif ! [[ -d "$begdir/$1/$i" ]] && ! [[ -d "$begdir/$2/$i" ]]	#Оба файла - файлы
		      then
			      #Сверяем даты. Если в первой директории более актуальный файл, ничего не делаем, иначе 	копируем с заменой из второй
		      	echo "  Сверяем даты"
		      	echo "$begdir/$1/$i"
		      	echo "$begdir/$2/$i"
			      t1="$(stat -c%Y "$begdir/$1/$i")"
			      t2="$(stat -c%Y "$begdir/$2/$i")"
			      if [ "$t2" > "$t1" ]	#Если во второй директории файл более актуальный
			      then
			      	cp -f "$begdir/$2/$i" "$begdir/$1"      	
			      fi 
			    else	#Если файл и папка в синхронизируемых директориях имеют одинаковое название - тут 	наши полномочия все
		     		echo "  Встречены файл и папка с одинаковыми названиями: $begdir/$1/$i и $begdir/$2/$i. 	Синхронизация остановлена"
			     	exit 1
		    	fi
			    j=$(($j+1))	#Переходим к следующем файлу второй директории
			    break	#и к следующему файлу первой
		    elif [ "$i" \< "${fs2[$j]}" ]
		    then
		    	#Переходим к следующему файлу первой директории
		      echo "  Ушли слишком далеко"
		      break
		    else
		      #Данного файла нету в первой директории
	      	echo "  Копируем ${fs2[$j]} в первую"
		      cp -f -r "$begdir/$2/${fs2[$j]}" "$begdir/$1"
		      j=$(($j+1))	#Переходим к следующем файлу второй директории
		    fi
		  done
		  
		  if [ "$flag" == "true" ] 
		  then
		  	break
		  fi
		done
			
		#Если перебраны не все файлы второй директории
		if [ "$flag" != "true" ]
		then
			while (("$j"<"${#fs2[@]}"))
			do
				echo "Копируем ${fs2[j]} в первую"
				cp -f -r "$begdir/$2/${fs2[$j]}" "$begdir/$1"
				j=$(($j+1))
			done
		fi
	fi
	
	if [[ ${fs1[@]} == "*" ]]
	then
		echo "Первая директория является/являлась пустой."
	else
		#Теперь просто копируем все файлы первой директории во вторую
		for i in ${fs1[@]}
		do
			cp -f -r "$begdir/$1/$i" "$begdir/$2"
		done
	fi
}	#Конец функции	


if [ $# != 2 ] 
then
	echo "Данный скрипт должен принимать два аргумента - два пути к синхронизируемым папкам"
	exit 1
fi

_copy $1 $2	#Вызываем нашу функцию

exit 0


